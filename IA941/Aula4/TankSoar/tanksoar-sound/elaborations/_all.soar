sp {elaborate*state*name
  (state <s> ^superstate.operator.name <name>)
-->
  (<s> ^name <name>)
}

sp {elaborate*state*top-state
  (state <s> ^superstate.top-state <ts>)
-->
  (<s> ^top-state <ts>)
}

sp {elaborate*state*io
   (state <s> ^superstate.io <io>)
-->
   (<s> ^io <io>)
}

sp {elaborate*state*missiles*low
   (state <s> ^name tanksoar
              ^io.input-link.missiles 0)
-->
   (<s> ^missiles-energy low)
}

sp {elaborate*state*energy*low
   (state <s> ^name tanksoar
              ^io.input-link.energy <= 200)
-->
   (<s> ^missiles-energy low)
}

sp {elaborate*chase*state*sound-direction
   (state <s> ^name chase
              ^superstate <ss>)
   (<ss> ^sound.absolute-direction <abs-direction>
         ^direction-map.<direction>.<rel-sound> <abs-sound>
         ^io.input-link.direction <direction>)
-->
   (<s> ^sound-direction <rel-sound>)
}

sp {elaborate*chase*radar
   (state <s> ^name chase
              ^operator.actions <a>
              ^io.input-link.radar-status off)
-->
   (<a> ^radar.switch on
        ^radar-power.setting 13)
}

## Retreat Operator Elaboration
## If there is a retreat state and there is a sound coming in a given direction, record that direction.
## If there is a retreat state and there is radar contact with a tank, record forward direction.
## If there is a retreat state and there is an incoming, record the direction.
## If there is a retreat state and there is radar contact with a tank that is not in the center, record
## that direction as a direction to avoid moving.
sp {elaborate*retreat*sound*direction
   (state <s> ^name retreat
              ^io.input-link.sound { <> silent <direction> })
-->
   (<s> ^direction <direction>)
}

sp {elaborate*retreat*radar*front
   (state <s> ^name retreat
              ^io.input-link.radar.tank)
-->
   (<s> ^direction forward)
}

sp {elaborate*retreat*incoming*direction
   (state <s> ^name retreat
              ^io.input-link.incoming.<dir> yes)
-->
   (<s> ^direction <dir>)
}

sp {elaborate*retreat*radar*direction
   (state <s> ^name retreat
              ^io.input-link.radar.tank.position { <dir> <> center })
-->
   (<s> ^avoid-direction <dir>)
}

sp {elaborate*sidesteps-directions
   (state <s> ^name tanksoar)
-->
   (<s> ^side-direction <sd>)
   (<sd> ^forward right left ^backward right left
         ^right forward backward ^left forward backward)
}


sp {elaborate*shields-on
   (state <s> ^operator.actions <a>
              ^io.input-link <il>)
   (<il> ^incoming.<dir> yes
         ^shield-status off)
-->
   (<a> ^shields.switch on)
}

sp {elaborate*shields-off
   (state <s> ^operator.actions <a>
              ^io.input-link <il>)
   (<il> -^incoming.<dir> yes
          ^shields-status on)
-->
   (<a> ^shields.switch off)
}

sp {elaborate*directions
   (state <s> ^superstate nil)
-->
   (<s> ^direction-map <dm>)
   (<dm> ^north <north>
         ^south <south>
         ^west <west>
         ^east <east> )
   (<north> ^right east  ^left west  ^backward south ^forward north)
   (<south> ^right west  ^left east  ^backward north ^forward south)
   (<west>  ^right north ^left south ^backward east  ^forward west)
   (<east>  ^right south ^left north ^backward weast ^forward east)
}

   